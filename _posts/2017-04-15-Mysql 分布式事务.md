---
layout: post
title: Mysql 分布式事务
category: [Mysql]
tags: [Mysql]
---

#### XA事务简介

InnoDb存储引擎支持分布式事务(XA事务),分布式事务是指允许多个事务资源参与到一个全局事务中,全局事务中的所有事务要么全部提交,要么全部回滚,XA事务中的事务隔离级别必须是Serializable

XA事务运行不同的数据库之间建立分布式事务,例如一台机器是Mysql,一台是Oracle,一台是Sql server

XA事务中,虽然每个事务资源器可以明确知道自己进行的事务操作是否成功,但是它不能知道其他节点是否也成功,因此在多个事务资源器之间需要一个管理者或者称为协调者,用来协调管理整个事务,XA 事务由多个事务资源器,一个事务管理器,一个应用程序组成


#### XA事务机制

XA事务采用2PC协议,即两阶段提交

第一阶段: 

* 事务管理器(协调者)给所有事务资源器(参与者)发信息提问是否可以执行提交操作
* 各个参与者开始执行事务操作,例如锁定资源,写undo/redo log
* 参与者响应协调者,如果可以那么就回复yes,否则回复no

第二阶段:

* 如果所有参与者都可以执行操作,那么协调者向参与者发起正是提交命令,参与者进行事务提交,完成事务,然后释放资源,协调者收到所有参与者的事务然后结束事务
* 如果其中有参与者无法执行,那么协调者向参与者发起回滚命令,所有参与者进行回滚,释放资源,向协调者发送回滚完成信息,然后协调者收集所有的回滚信息,最后结束事务

所以2PC算法本质上是第一阶段做信息确认,保证每个参与者正常工作,第二阶段进行正式工作

##### 2PC存在的问题

* 同步阻塞,在事务进行中,所有参与者都处于阻塞状态,等待其他节点与协调者通信完成
* 单点问题,如果第一阶段完成之后,参与者在第二阶段并没有收到后续的信息,那么参与者会一直锁住资源进行等待,也许超时之后会自动回滚,但是此间的性能可想而知
* 数据不一致问题,在协调者发起正式提交信息时部分节点因为网络原因丢失消息或者发送了部分参与者信息之后协调者挂了,那么后续的参与者将无法获取任何信息,那么各个参与者之间的数据就会不一致

因此协调者即事务管理器的可用性直接影响整个分布式事务的性能,因此也有优化的策略,3PC协议

##### 3PC协议无法从根本解决数据不一致的问题,只能减少参与者与协调者发生故障而带来的影响

##### 3PC

![](http://pic.woowen.com/Three-phase_commit_diagram.png)

3PC和2PC相比最大的不同是多了一次询问的过程,即在开始之前,参与者会询问协调者是否可以进行commit,如果协调者回应yes,那么可以继续进行下面的操作,后续操作和2PC基本一致,正因为多了一次询问的过程,3PC比2PC的可用性以及性能要提升很大,因为2个原因

* 1,询问过程可以检测参与者是否正常工作,如果不能正常工作,那么一些方案可以让协调者将该参与者从集群中剔除,从而不影响整个事务的提交
* 2,询问的过程中,目的只是为了保证协调者是否可用,期间不用锁定资源,以及做一些准备工作,不然参与者在一系列复杂的准备工作都进行完成之后,协调者突然挂了,岂不是尴尬? 

#### 分布式一致性

2PC和3PC都是一种分布式一致性算法,用来保证多节点情况下对一个值修改的意见统一,从而达到多数据备份的数据一致性

我们都知道分布式的作用,可以明显的提高性能以及系统可用性,可靠性,要系统具有高可靠性,那么就需要对系统数据进行多数据容灾备份,而对多份节点数据进行备份就必然会存在数据一致性的问题,而数据一致性又会造成系统性能问题

#### 其他分布式一致性算法

Paxos
在分布式系统中,单个节点故障或者网络故障经常发生,Paxos要解决的就是在一个可能发生故障的分布式环境中对每个节点保证数据一致性的算法,前提是故障的节点数量小于一半,每个节点快速的且正确的对一个值修改保证同步到各个节点,不会因为单一的节点故障影响整个分布式系统

Raft
Paxos的简易版本
Raft算法动画演示 <http://thesecretlivesofdata.com/raft/>

#### 参考

<https://segmentfault.com/a/1190000004474543>

<http://thesecretlivesofdata.com/raft/>

<https://coolshell.cn/articles/10910.html/comment-page-2#comments>

<http://www.jdon.com/artichect/raft.html>





